<!DOCTYPE HTML>
<!--
	Forty by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>ChainYen System</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		{% load static %}
		<link rel="stylesheet" href="{%static 'assets/css/main.css' %}" />

		<noscript><link rel="stylesheet" href="{%static 'assets/css/noscript.css' %}" /></noscript>
		<style type="text/css">
        html,body,#pdf_viewer{
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					{% include 'baseHeader.html' %}

				<!-- Menu -->
					{% include 'baseMenu.html' %}

				<!-- Main -->
				{% if permission is False %}
				<p>權限不足</p>
				{% elif pointEnough is False %}
				<p>點數不足</p>
				{% else %}
					<div id="main" class="alt">

						<!-- One -->
							<section id="one">
								<div class="inner">
									<header class="major">
										<h2>{{targetFile.title}}</h2>
									</header>
									<p>{{targetFile.describe}}</p>
									<input type="hidden" id="fileID" value = "{{targetFile.id}}">
									<hr>
									<p>關鍵字:
										{% for keywords in targetFile.filedatakeywords_set.all %}
												#{{keywords.keyword}}
										{% endfor %}
									</p>
									<hr>
									{% if targetFile.fileType == 1 %}
									{% else %}

									{% endif %}

									</div>

							</section>

					</div>
				{% endif %}


			</div>
				<div id="pdf_viewer" ></div>

		<!-- Scripts -->
			<script src="{%static 'assets/js/jquery.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrolly.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrollex.min.js' %}"></script>
			<script src="{%static 'assets/js/browser.min.js' %}"></script>
			<script src="{%static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{%static 'assets/js/util.js' %}"></script>
			<script src="{%static 'assets/js/main.js' %}"></script>
			<script src="{%static 'assets/js/viewPageAjax.js' %}"></script>
<!--			<script type="text/javascript" src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>-->
<!--    		<script type="text/javascript" src="https://mozilla.github.io/pdf.js/build/pdf.worker.js"></script>-->
			<script type="text/javascript" src="{%static 'assets/js/pdfobject.min.js'%}"></script>
			<script type="text/javascript" src="{%static 'pdfjs-2.0/build/pdf.js'%}"></script>
<!--			<script type="text/javascript" src="{%static 'assets/js/build/pdf.worker.js'%}"></script>-->



			<script>

				var t = 100
				var my_refresh = setInterval(ajpdf, t); // the "1000"

				function ajpdf() {
				let csrftoken = '{{ csrf_token }}'
				var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
				// var dataJSON = {};

				$.ajax({
						url: requestURL,
						// data: JSON.stringify(dataJSON),
						headers:{'X-CSRFToken':csrftoken},
						type: "GET",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",
						success: function(returnData){

							if(returnData != "error" && returnData != "not ready"){
								if(PDFObject.supportsPDFs) {
									var options = {
										pdfOpenParams: {
											pagemode: "thumbs",
											toolbar: 0,
											navpanes: 1,
											statesbar: 1,
											scrollbar: 1,
											view: 'FitV'
										}
									}
									PDFObject.embed("{% url 'returnPDF' targetFile.id %}", "#pdf_viewer", options);
									clearInterval(my_refresh)
								}else{
									clearInterval(my_refresh)
									pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdfjs-2.0/build/pdf.worker.js' %}";

									pdfjsLib.getDocument("{% url 'returnPDF' targetFile.id %}").promise.then(function (pdf) {
										for (var pageNum = 1; pageNum <= pdf.numPages; ++pageNum) {
											pdf.getPage(pageNum).then(function (page) {
												// you can now use *page* here

												var scale = 0.7;
												var viewport = page.getViewport({
														  scale: scale, // 缩放的比例
														  rotation: 360, // 旋转的角度
														});
												// page.rotatePages(180)
												var canvas = document.createElement('canvas');
												var context = canvas.getContext('2d');
												canvas.height = viewport.viewBox[3]*scale;
												canvas.width = viewport.viewBox[2]*scale;
												console.log(viewport.rotation)


												var renderContext = {
													canvasContext: context,
													viewport: viewport
												};
												page.render(renderContext);
												document.getElementById('pdf_viewer').appendChild(canvas);
											});
										}
									})
								}
						}else{
								if (t<3000){
								clearInterval(my_refresh)
								t = 3000
								my_refresh = setInterval(ajpdf, t);
								}
								if (returnData == "not ready"){
									document.getElementById("pdf_viewer").innerHTML = "正在產生檔案..請稍候";
								}else{
									document.getElementById("pdf_viewer").innerHTML = "發生錯誤";
								}
							}},
						error: function(xhr, ajaxOptions, thrownError){
							if (t<3000){
								clearInterval(my_refresh)
								t = 3000
								my_refresh = setInterval(ajpdf, t);
							}

							console.log(xhr.status);
							console.log(thrownError);

						}
					});

				}
				$(document).ready(function() {
				$.ajaxSetup({ cache: false }); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh


				});

			</script>
	</body>
</html>