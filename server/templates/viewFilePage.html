<!DOCTYPE HTML>
<!--
	Forty by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->

<html>
<head>
	<title>ChainYen System</title>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

	{% load static %}
	<link href="{%static 'favicon.ico' %}" rel="shortcut icon">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		  integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

	<link rel="stylesheet" href="{%static 'assets/css/main.css' %}"/>

	<noscript>
		<link rel="stylesheet" href="{%static 'assets/css/noscript.css' %}"/>
	</noscript>
	<style type="text/css">
		html, body, #pdf_viewer {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}
	</style>
	<style>
		#myProgress {
			position: relative;
			width: 100%;
			height: 30px;
			background-color: #ddd;
		}

		#myBar {
			position: absolute;
			width: 1%;
			height: 100%;
			background-color: #4CAF50;
		}
		p {color:black;}
		b {color:black;}
		.button {
			border: 1px solid black;
			color:black;
		}
	</style>
</head>
	<body class="is-preload" style="background-size: Cover;background:url('{%static 'images/login底圖.png' %}');">

		<!-- Wrapper -->
			<div id="wrapper" class="container" >

				<!-- Header -->
					{% include 'baseHeader.html' %}

				<!-- Menu -->
					{% include 'baseMenu.html' %}

				<!-- Main -->
				{% if permission is False %}
				<p>權限不足</p>
				{% elif pointEnough is False %}
				<p>點數不足</p>
				{% else %}
					<div id="main" class="alt">

						<!-- One -->
							<section id="one">
								<div class="inner">
									<header class="">
										<h3><b>{{targetFile.title}}</b></h3>
									</header>
									<p>{{targetFile.describe}}</p>
									<input type="hidden" id="fileID" value = "{{targetFile.id}}">
									<p>關鍵字:
										{% for keywords in targetFile.filedatakeywords_set.all %}
												#{{keywords.keyword}}
										{% endfor %}
									</p>
									{% if alreadyExchange is False %}
									<ul class="actions">
										<li>

											{% if UserAccountChainYen.point >= targetFile.point %}
											<button type="button" class="button" data-toggle="modal"
													data-target="#confirmViewFile"
													onclick="confirmViewFile({{ targetFile.id }},'{{targetFile.title}}',{{ targetFile.point }},{{UserAccountChainYen.point}})">
												兌換觀看【{{targetFile.point}}點】
											</button>
											{% else %}
											<button type="button" class="button" data-toggle="modal"
													data-target="#confirmViewFile" disabled>
												兌換觀看【{{targetFile.point}}點】
											</button>
											{% endif %}
										</li>
									</ul>


									{% endif %}
									{% if alreadyExchange %}
										{% if targetFile.fileType.id == 1 %}
										<p id="videoWait">影片載入中請稍候....</p>
										<div id="myProgress">
										  <div id="myBar"></div>
										</div>

										<video id="demo"  preload="media"  playsinline controls width='100%'
											   style="display:none;" height='100%'
											   src='' type='video/mp4' controlsList="nodownload" oncontextmenu="return false;">
											<source id=fileVideo type="video/mp4"></source>
										</video>

										{% else %}
										<p id="PDFWait">PDF載入中請稍候....</p>
										<div id="myProgress">
										  <div id="myBar"></div>
										</div>
										<div id="pdf_viewer_newer" class="container" controlsList="nodownload" oncontextmenu="return false;"></div>
										{% endif %}
									{% endif %}
								</div>

							</section>

					</div>

				{% endif %}

			</div>
		{% if alreadyExchange %}

		{% else %}

		<div class="modal fade" id="confirmViewFile" tabindex="-1" role="dialog"
			 aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3 style="color: black" class="modal-title"
							id="fileCheckTitle"></h3>
<!--						<h3 style="color: black" class="modal-title" id="needPoint"></h3>-->
						<button type="button" class="close" data-dismiss="modal"
								aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body" id="modal-boyd">
						<p style="color: black" id="userpoint"></p>
						<label style="color: red"
							   for="demo-copy">*兌換即同意不截圖、不錄音、不錄影、不外流</label>
					</div>
					<div class="modal-footer">
						<form action="22" id="fileIDModal" name="fileIDModal" method="post">
							{% csrf_token %}
							<input type="hidden" id="fileViewID">
						</form>

						<button type="button" class="btn btn-secondary"
								data-dismiss="modal">取消
						</button>
						<button type="button" class="btn btn-primary"
								onclick="confirmViewFileSubmit()">我同意並兌換
						</button>
					</div>
				</div>
			</div>
		</div>
		{% endif %}


		<!-- Scripts -->
			<script src="{%static 'assets/js/jquery.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrolly.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrollex.min.js' %}"></script>
			<script src="{%static 'assets/js/browser.min.js' %}"></script>
			<script src="{%static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{%static 'assets/js/util.js' %}"></script>
			<script src="{%static 'assets/js/main.js' %}"></script>
			<script src="{%static 'assets/js/cyMain.js' %}"></script>
			<script src="{%static 'assets/js/viewPageAjax.js' %}"></script>
			<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
			<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


			<script type="text/javascript" src="{%static 'assets/js/pdfobject.min.js'%}"></script>
			<script type="text/javascript" src="{%static 'pdfjs-2.0/build/pdf.js'%}"></script>
			<script>


			</script>
			{% if alreadyExchange %}
			{% if targetFile.fileType.id != 1 %}
			<script>
				$('.loading').animate({'width':'33%'},50);
				var t = 2000
				ajpdf()
				var my_refresh // the "1000"
				var successgetvideo = 0
				var width = 1;
				function ajpdf() {
					let csrftoken = '{{ csrf_token }}'
					var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
					var requestStatus = "/returnFileStatus/" + document.getElementById("fileID").value;
					// var dataJSON = {};
					clearInterval(my_refresh)
					$.ajax({
						url: requestStatus,
						// data: JSON.stringify(dataJSON),
						headers: {'X-CSRFToken': csrftoken},
						type: "GET",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",

						success: function (returnData) {

							if (returnData != "error" && returnData != "not ready") {
								successgetvideo = 1
								clearInterval(my_refresh)
								pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdfjs-2.0/build/pdf.worker.js' %}";

								pdfjsLib.getDocument("{% url 'returnPDF' targetFile.id %}").promise.then(function (pdf) {
									document.getElementById("myProgress").style.display = "none"
									document.getElementById("myBar").style.display = "none"
									document.getElementById("PDFWait").style.display = "none"
									width=100
									for (var pageNum = 1; pageNum <= pdf.numPages; ++pageNum) {
										pdf.getPage(pageNum).then(function (page) {
											// you can now use *page* here

											var scale = 0.7;
											var viewport = page.getViewport({
												scale: scale, // 缩放的比例
												rotation: 360, // 旋转的角度
											});
											// page.rotatePages(180)
											var canvas = document.createElement('canvas');
											var context = canvas.getContext('2d');
											canvas.height = viewport.viewBox[3] * scale;
											canvas.width = viewport.viewBox[2] * scale;


											var renderContext = {
												canvasContext: context,
												viewport: viewport
											};
											var task = page.render(renderContext);
											task.promise.then(() => {
												var pdfImg = document.createElement("img");
												pdfImg.src = canvas.toDataURL("image/jpeg");
												pdfImg.classList.add("img-fluid");
												document.getElementById('pdf_viewer_newer').appendChild(pdfImg);
											})

										});
									}
								})
							} else {

								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);

							}
						},
						error: function (xhr, ajaxOptions, thrownError) {
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);


						}
					});

				}

				$(document).ready(function () {
					$.ajaxSetup({cache: false}); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh
					var elem = document.getElementById("myBar");

					  var id = setInterval(frame, 300);
					  function frame() {
						if (width >= 95) {
						  clearInterval(id);
						} else {
						  width++;
						  elem.style.width = width + '%';
						}
					  }

				});

			</script>
			{% endif %}
			{% if targetFile.fileType.id == 1 %}
			<script>
				var width = 1;
				var t = 2000
				ajpdf()
				var my_refresh // the "1000"
				var successgetvideo = 0

				function ajpdf() {
					let csrftoken = '{{ csrf_token }}'
					var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
					var requestStatus = "/returnFileStatus/" + document.getElementById("fileID").value;
					// var dataJSON = {};
					clearInterval(my_refresh)
					$.ajax({
						url: requestStatus,
						// data: JSON.stringify(dataJSON),
						headers: {'X-CSRFToken': csrftoken},
						type: "GET",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",

						success: function (returnData) {

							if (returnData != "error" && returnData != "not ready") {
								successgetvideo = 1
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								width = 100


								document.getElementById("myProgress").style.display = "none"
								document.getElementById("myBar").style.display = "none"
								document.getElementById("videoWait").style.display = "none"
								document.getElementById("demo").style.display = "";
								$('#demo').attr('src', requestURL+"#t=0.1");
							} else {


								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);

							}
						},
						error: function (xhr, ajaxOptions, thrownError) {
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);


						}
					});

				}

				$(document).ready(function () {
					$.ajaxSetup({cache: false}); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh
					var elem = document.getElementById("myBar");

					  var id = setInterval(frame, 300);
					  function frame() {
						if (width >= 95) {
						  clearInterval(id);
						} else {
						  width++;
						  elem.style.width = width + '%';
						}
					  }

				});

			</script>
			{% endif %}
			{% endif %}

	</body>
</html>