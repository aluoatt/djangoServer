<!DOCTYPE HTML>
<!--
	Forty by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->

<html>
	<head>
		<title>ChainYen System</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

		{% load static %}
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

		<link rel="stylesheet" href="{%static 'assets/css/main.css' %}" />

		<noscript><link rel="stylesheet" href="{%static 'assets/css/noscript.css' %}" /></noscript>
		<style type="text/css">
        html,body,#pdf_viewer{
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					{% include 'baseHeader.html' %}

				<!-- Menu -->
					{% include 'baseMenu.html' %}

				<!-- Main -->
				{% if permission is False %}
				<p>權限不足</p>
				{% elif pointEnough is False %}
				<p>點數不足</p>
				{% else %}
					<div id="main" class="alt">

						<!-- One -->
							<section id="one">
								<div class="inner">
									<header class="major">
										<h2>{{targetFile.title}}</h2>
									</header>
									<p>{{targetFile.describe}}</p>
									<input type="hidden" id="fileID" value = "{{targetFile.id}}">
									<hr>
									<p>關鍵字:
										{% for keywords in targetFile.filedatakeywords_set.all %}
												#{{keywords.keyword}}
										{% endfor %}
									</p>
									<hr>
									{% if alreadyExchange is False %}
									<ul class="actions">
										<li>

											{% if UserAccountChainYen.point >= targetFile.point %}
											<button type="button" class="button" data-toggle="modal"
													data-target="#confirmViewFile"
													onclick="confirmViewFile({{ targetFile.id }},'{{targetFile.title}}',{{ targetFile.point }},{{UserAccountChainYen.point}})">
												兌換觀看【{{targetFile.point}}點】
											</button>
											{% else %}
											<button type="button" class="button" data-toggle="modal"
													data-target="#confirmViewFile" disabled>
												兌換觀看【{{targetFile.point}}點】
											</button>
											{% endif %}
										</li>
									</ul>


									{% endif %}
									{% if alreadyExchange %}
										{% if targetFile.fileType.id == 1 %}
										<p id="videoWait">影片載入中請稍候....</p>
										<video id="demo"  playsinline controls width='100%'
											   style="display:none;" height='100%'
											   src='' type='video/mp4'>
											<source id=fileVideo type="video/mp4"></source>
										</video>

										{% else %}
										<div id="pdf_viewer"></div>
										{% endif %}
									{% endif %}
								</div>

							</section>

					</div>

				{% endif %}

			</div>
		{% if alreadyExchange %}
<!--			{% if targetFile.fileType.id == 1 %}-->
<!--			<p  id = "videoWait">影片載入中請稍候....</p>-->
<!--			<video id = "demo" loop autoplay playsinline controls width='100%' style="display:none;" height='100%' src='' type='video/mp4'>-->
<!--				<source id = fileVideo type="video/mp4" ></source>-->
<!--			</video>-->

<!--			{% else %}-->
<!--				<div id="pdf_viewer"></div>-->
<!--			{% endif %}-->
		{% else %}

		<div class="modal fade" id="confirmViewFile" tabindex="-1" role="dialog"
			 aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3 style="color: black" class="modal-title"
							id="fileCheckTitle"></h3>
						<h3 style="color: black" class="modal-title" id="needPoint"></h3>
						<button type="button" class="close" data-dismiss="modal"
								aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body" id="modal-boyd">
						<p style="color: black" id="userpoint"></p>
						<label style="color: red"
							   for="demo-copy">*兌換即同意不截圖、不錄音、不錄影、不外流</label>
					</div>
					<div class="modal-footer">
						<form action="22" id="fileIDModal" name="fileIDModal" method="post">
							{% csrf_token %}
							<input type="hidden" id="fileViewID">
						</form>
						>
						<button type="button" class="btn btn-secondary"
								data-dismiss="modal">取消
						</button>
						<button type="button" class="btn btn-primary"
								onclick="confirmViewFileSubmit()">我同意並兌換
						</button>
					</div>
				</div>
			</div>
		</div>
		{% endif %}


		<!-- Scripts -->
			<script src="{%static 'assets/js/jquery.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrolly.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrollex.min.js' %}"></script>
			<script src="{%static 'assets/js/browser.min.js' %}"></script>
			<script src="{%static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{%static 'assets/js/util.js' %}"></script>
			<script src="{%static 'assets/js/main.js' %}"></script>
			<script src="{%static 'assets/js/cyMain.js' %}"></script>
			<script src="{%static 'assets/js/viewPageAjax.js' %}"></script>
<!--			<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>-->
			<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
			<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


			<script type="text/javascript" src="{%static 'assets/js/pdfobject.min.js'%}"></script>
			<script type="text/javascript" src="{%static 'pdfjs-2.0/build/pdf.js'%}"></script>
			{% if alreadyExchange %}
			{% if targetFile.fileType.id != 1 %}
			<script>

				var t = 4000
				ajpdf()
				var my_refresh // the "1000"
				var successgetvideo = 0

				function ajpdf() {
					let csrftoken = '{{ csrf_token }}'
					var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
					// var dataJSON = {};

					$.ajax({
						url: requestURL,
						// data: JSON.stringify(dataJSON),
						headers: {'X-CSRFToken': csrftoken},
						type: "GET",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",
						success: function (returnData) {

							if (returnData != "error" && returnData != "not ready") {
								successgetvideo = 1
								clearInterval(my_refresh)
								pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdfjs-2.0/build/pdf.worker.js' %}";

								pdfjsLib.getDocument("{% url 'returnPDF' targetFile.id %}").promise.then(function (pdf) {
									for (var pageNum = 1; pageNum <= pdf.numPages; ++pageNum) {
										pdf.getPage(pageNum).then(function (page) {
											// you can now use *page* here

											var scale = 0.7;
											var viewport = page.getViewport({
												scale: scale, // 缩放的比例
												rotation: 360, // 旋转的角度
											});
											// page.rotatePages(180)
											var canvas = document.createElement('canvas');
											var context = canvas.getContext('2d');
											canvas.height = viewport.viewBox[3] * scale;
											canvas.width = viewport.viewBox[2] * scale;


											var renderContext = {
												canvasContext: context,
												viewport: viewport
											};
											page.render(renderContext);
											document.getElementById('pdf_viewer').appendChild(canvas);
										});
									}
								})
							} else {

								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);
								// if (t<3000){
								// clearInterval(my_refresh)
								// t = 3000
								// my_refresh = setInterval(ajpdf, t);
								// }
								// if (returnData == "not ready"){
								// 	document.getElementById("pdf_viewer").innerHTML = "正在產生檔案..請稍候";
								// }else{
								// 	document.getElementById("pdf_viewer").innerHTML = "發生錯誤";
								// }
							}
						},
						error: function (xhr, ajaxOptions, thrownError) {
							if (t < 3000) {
								clearInterval(my_refresh)
								t = 3000
								my_refresh = setInterval(ajpdf, t);
							}

							console.log(xhr.status);
							console.log(thrownError);

						}
					});

				}

				$(document).ready(function () {
					$.ajaxSetup({cache: false}); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh


				});

			</script>
			{% endif %}
			{% if targetFile.fileType.id == 1 %}
			<script>

				var t = 4000
				ajpdf()
				var my_refresh // the "1000"
				var successgetvideo = 0

				function ajpdf() {
					let csrftoken = '{{ csrf_token }}'
					var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
					// var dataJSON = {};

					$.ajax({
						url: requestURL,
						// data: JSON.stringify(dataJSON),
						headers: {'X-CSRFToken': csrftoken},
						type: "GET",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",
						success: function (returnData) {

							if (returnData != "error" && returnData != "not ready") {
								successgetvideo = 1
								clearInterval(my_refresh)
								document.getElementById("videoWait").style.display = "none"
								document.getElementById("demo").style.display = "";
								$('#demo').attr('src', requestURL);
							} else {

								clearInterval(my_refresh)
								my_refresh = setInterval(ajpdf, t);
								// if (t<3000){
								// clearInterval(my_refresh)
								// t = 3000
								// my_refresh = setInterval(ajpdf, t);
								// }
								// if (returnData == "not ready"){
								// 	document.getElementById("pdf_viewer").innerHTML = "正在產生檔案..請稍候";
								// }else{
								// 	document.getElementById("pdf_viewer").innerHTML = "發生錯誤";
								// }
							}
						},
						error: function (xhr, ajaxOptions, thrownError) {
							if (t < 3000) {
								clearInterval(my_refresh)
								t = 3000
								my_refresh = setInterval(ajpdf, t);
							}

							console.log(xhr.status);
							console.log(thrownError);

						}
					});

				}

				$(document).ready(function () {
					$.ajaxSetup({cache: false}); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh


				});

			</script>
			{% endif %}
			{% endif %}
	</body>
</html>