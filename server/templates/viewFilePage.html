<!DOCTYPE HTML>
<!--
	Forty by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>ChainYen System</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		{% load static %}
		<link rel="stylesheet" href="{%static 'assets/css/main.css' %}" />

		<noscript><link rel="stylesheet" href="{%static 'assets/css/noscript.css' %}" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					{% include 'baseHeader.html' %}

				<!-- Menu -->
					{% include 'baseMenu.html' %}

				<!-- Main -->
				{% if permission is False %}
				<p>權限不足</p>
				{% elif pointEnough is False %}
				<p>點數不足</p>
				{% else %}
					<div id="main" class="alt">

						<!-- One -->
							<section id="one">
								<div class="inner">
									<header class="major">
										<h2>{{targetFile.title}}</h2>
									</header>
									<p>{{targetFile.describe}}</p>
									<input type="hidden" id="fileID" value = "{{targetFile.id}}">
									<hr>
									<p>關鍵字:
										{% for keywords in targetFile.filedatakeywords_set.all %}
												#{{keywords.keyword}}
										{% endfor %}
									</p>
									<hr>
									{% if targetFile.fileType == 1 %}
									{% else %}
									<div id="pdf-container"></div>
									{% endif %}
									</div>
							</section>

					</div>
				{% endif %}


			</div>

		<!-- Scripts -->
			<script src="{%static 'assets/js/jquery.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrolly.min.js' %}"></script>
			<script src="{%static 'assets/js/jquery.scrollex.min.js' %}"></script>
			<script src="{%static 'assets/js/browser.min.js' %}"></script>
			<script src="{%static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{%static 'assets/js/util.js' %}"></script>
			<script src="{%static 'assets/js/main.js' %}"></script>
			<script src="{%static 'assets/js/viewPageAjax.js' %}"></script>
			<script type="text/javascript" src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    		<script type="text/javascript" src="https://mozilla.github.io/pdf.js/build/pdf.worker.js"></script>
			<script>
				$(document).ready(function() {
				$.ajaxSetup({ cache: false }); // This part addresses an IE bug. without it, IE will only load the first number and will never refresh
				var my_refresh = setInterval(function() {
				let csrftoken = '{{ csrf_token }}'
				var requestURL = "/returnPDF/" + document.getElementById("fileID").value;
				var dataJSON = {};
				// dataJSON["fileId"] = "iPhone";
				// dataJSON["Company"] = "Apple";

				$.ajax({
						url: requestURL,
						data: JSON.stringify(dataJSON),
						headers:{'X-CSRFToken':csrftoken},
						type: "POST",
						// dataType: "json",
						// contentType: "application/json;charset=utf-8",
						success: function(returnData){
							clearInterval(my_refresh)
							if(returnData != "error"){
								 btoa(unescape(encodeURIComponent(JSON.stringify(Object))))
							pdfjsLib.getDocument(convertDataURIToBinary(returnData)).then(function(pdf) {
								  for (var pageNum = 1; pageNum < pdf.numPages; ++pageNum) {
									pdf.getPage(pageNum).then(function(page) {
									  // you can now use *page* here

									  var scale = 1.5;
									  var viewport = page.getViewport(1);

									  var canvas = document.createElement('canvas');
									  var context = canvas.getContext('2d');
									  canvas.height = viewport.height;
									  canvas.width = viewport.width;

									  var renderContext = {
										canvasContext: context,
										viewport: viewport
									  };
									  page.render(renderContext);

									  document.getElementById('pdf-container').appendChild(canvas);
									});
								  }
								})
						}

							},
						error: function(xhr, ajaxOptions, thrownError){
							console.log(xhr.status);
							console.log(thrownError);
						}
					});

				}, 3000); // the "1000"
				});
				var BASE64_MARKER = ';base64,';

				function convertDataURIToBinary(dataURI) {
				  var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
				  var base64 = dataURI.substring(base64Index);
				  var raw = window.atob(base64);
				  var rawLength = raw.length;
				  var array = new Uint8Array(new ArrayBuffer(rawLength));

				  for(var i = 0; i < rawLength; i++) {
					array[i] = raw.charCodeAt(i);
				  }
				  return array;
}
			</script>
	</body>
</html>